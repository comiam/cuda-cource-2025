# Отчет по лабораторной рабоеа №5

## 1. Задачи работы

В рамках лабораторной работы была реализована система детекции объектов с использованием TensorRT для оптимизации нейронной сети. Основные задачи включали:

- Реализация конвертации ONNX модели в оптимизированный TensorRT engine
- Поддержка динамических размеров батча (от 1 до 16 изображений)
- Реализация INT8 квантования с калибровкой для ускорения инференса
- Обработка изображений и видео с детекцией объектов
- Интеграция с моделью YOLOv10 для детекции объектов

Проект основан на примерах из официального репозитория TensorRT (NVIDIA), в частности, классы для управления буферами (`Buffers.h`, `half.h`) взяты из оригинального репозитория [TensorRT](https://github.com/NVIDIA/TensorRT).

## 2. Инструкции по запуску

**Требования**
- CUDA
- TensorRT 10.14.1.48
- OpenCV 4.x
- CMake 3.23+

**Сборка проекта**: `make build`.

**Запуск на изображениях**: `make run_images`

**Запуск на видео**: `make run_video`

**Сравнение производительности с INT8 оптимизацией**: `make compare`


### Формат запуска

```bash
./build/DetectionModelTRT <onnx_file> <images|video> <path_to_input> <int8_optimization>
```

Где:
- `onnx_file` - путь к ONNX модели
- `images|video` - тип входных данных
- `path_to_input` - путь к папке с изображениями или видео файлу
- `int8_optimization` - включить INT8 оптимизацию (`true`/`false`, `1`/`0`, `yes`/`no`)

## 3. Примеры работы

### Пример выполнения

При запуске на изображениях программа:
1. Загружает ONNX модель и конвертирует её в TensorRT engine (если engine файл отсутствует)
2. Обрабатывает все изображения из указанной папки
3. Выполняет детекцию объектов батчами
4. Сохраняет результаты в папку `results/trt/` с нарисованными bounding boxes

Пример вывода:
```
Building Engine with params:
- ONNX file path: models/yolov10s_dyn.onnx
- Engine file name: models/yolov10s_dyn.engine
- Optimizations: INT8=false FP16=false BF16=false
- Input (HxWxC): 640x640x3
- Output: 300x6
Total number of Images in directory: 15
Batch size=15 took X.XX ms, X.XX ms/img
```

При обработке видео программа:
1. Читает видео по кадрам
2. Обрабатывает кадры батчами размером 16
3. Применяет детекцию объектов
4. Сохраняет обработанное видео в `videos/processed.avi`

### Результаты детекции

Результаты обработки изображений сохраняются в формате PNG с нарисованными прямоугольниками вокруг обнаруженных объектов и метками классов. Обработанное видео сохраняется в формате AVI.

**Сравнение времени работы**:
Без INT8: `20.5188 ms/img`, с INT8: `13.5397 ms/img`. Сборка движка с калибровкой занимает больше времени, однако это выполняется единственный раз для данной версии Cuda/драйверов и архитектуры видеокарты. Ускорение практически на 30% на достаточно маленькой модели. Чем больше модель, тем значительнее разница.

## 4. Выводы

В ходе работы была реализована система детекции объектов с использованием TensorRT.

Реализована поддержка динамических размеров батча (1-16), что позволяет эффективно обрабатывать различное количество входных данных без перекомпиляции движка. Реализована поддержка INT8 оптимизации с калибровкой, что позволяет дополнительно ускорить инференс при небольшой потере точности.
