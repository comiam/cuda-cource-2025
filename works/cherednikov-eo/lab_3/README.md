# Lab 3: Sobel Operator - Оператор Собеля

## Описание

Реализация фильтра Собеля для обнаружения границ в изображениях с использованием CUDA. Программа загружает изображения в форматах PGM, PNG или BMP, применяет оператор Собеля на GPU и сохраняет результат в любом из поддерживаемых форматов.

## Требования

- CUDA Toolkit 11.0 или выше
- GPU с compute capability 7.0+
- Linux с GCC 9.0+ или Windows с Visual Studio
- Make (для Linux) или nvcc напрямую

## Оператор Собеля

Оператор Собеля использует две маски свертки для вычисления градиентов:

```
Gx = [-1  0  1]    Gy = [-1 -2 -1]
     [-2  0  2]         [ 0  0  0]
     [-1  0  1]         [ 1  2  1]

Magnitude = √(Gx² + Gy²)
```

Магнитуда градиента показывает силу границы в каждом пикселе.

## Компиляция

### Linux:
```bash
make
```

### Windows (с nvcc):
```bash
nvcc -O3 -arch=sm_75 -std=c++11 -Iheaders -o lab_3.exe src/main.cu src/sobel.cu src/image_io.cpp
```

### Очистка:
```bash
make clean        # Linux
make clean-win    # Windows
```

## Запуск

```bash
./lab_3 <input> <output>
```

Формат входного и выходного файла определяется автоматически по расширению.

### Примеры:
```bash
# PGM формат
./lab_3 input.pgm edges.pgm

# PNG формат (требует stb_image - см. PNG_SUPPORT.md)
./lab_3 input.png edges.png

# BMP формат
./lab_3 input.bmp edges.bmp

# Конвертация между форматами
./lab_3 input.png edges.bmp
./lab_3 input.bmp result.pgm
```

## Формат изображений

Программа поддерживает следующие форматы:

### PGM (Portable Gray Map) P5
- ✅ Полностью поддерживается
- Одноканальные изображения в градациях серого
- Максимальное значение пикселя: 255
- Бинарный формат

### BMP (Bitmap)
- ✅ Полностью поддерживается
- Поддерживаются 24-bit и 32-bit BMP
- Автоматическая конвертация RGB в grayscale
- Обработка перевернутого формата BMP (снизу вверх)

### PNG (Portable Network Graphics)
- ⚠️ Требует библиотеку stb_image для полной поддержки
- См. `PNG_SUPPORT.md` для инструкций по установке
- Базовая проверка формата реализована

### Автоматическая конвертация

- Цветные изображения (RGB) автоматически конвертируются в grayscale
- Формула конвертации: `0.299*R + 0.587*G + 0.114*B`
- Можно использовать изображения разных форматов для входа и выхода

## Структура проекта

```
lab_3/
├── README.md              # Этот файл
├── PNG_SUPPORT.md         # Инструкции по поддержке PNG
├── Makefile               # Файл сборки
├── headers/
│   ├── error_check.cuh   # Макросы для проверки ошибок CUDA
│   ├── image_io.h         # Универсальные функции I/O
│   ├── sobel.cuh          # Заголовочный файл для Sobel
│   ├── stb_image.h        # Заголовок для stb_image (опционально)
│   └── stb_image_write.h  # Заголовок для stb_image_write (опционально)
└── src/
    ├── main.cu            # Основная программа
    ├── sobel.cu           # CUDA kernel для оператора Собеля
    └── image_io.cpp       # Реализация загрузки/сохранения (PGM, PNG, BMP)
```

## Реализация

### Основные компоненты:

1. **image_io.cpp/h** - Универсальная загрузка и сохранение изображений
   - `loadImage()` - загружает изображение (PGM, PNG, BMP)
   - `saveImage()` - сохраняет изображение в нужном формате
   - `getImageFormat()` - определяет формат по расширению
   - `rgbToGrayscale()` - конвертирует RGB в grayscale
   - `freeImage()` - освобождает память

2. **sobel.cu/cuh** - Реализация оператора Собеля на CUDA
   - `sobelKernel()` - CUDA kernel для параллельной обработки
   - `applySobelGPU()` - функция-обертка для запуска kernel

3. **main.cu** - Основная программа
   - Загрузка изображения (любой поддерживаемый формат)
   - Применение фильтра на GPU
   - Сохранение результата (любой поддерживаемый формат)

### Оптимизации:

- Использование 2D блоков потоков (16x16) для эффективной обработки изображений
- Коалесцированный доступ к памяти
- Обработка границ изображения в kernel
- Измерение времени выполнения на GPU

## Примеры результатов

```
Входное изображение: 1920x1080
Loaded PGM image: 1920x1080
Applying Sobel operator on GPU...
GPU processing time: 5.234 ms
Saved PGM image: edges.pgm (1920x1080)
Edge detection completed successfully!
```

## Тестирование

Программа была протестирована на:
- Изображениях различных размеров (от 32x32 до 4096x4096)
- Стандартных тестовых изображениях (Lena, Mandrill и др.)
- Граничных случаях (маленькие изображения, изображения с четкими границами)

## Особенности реализации

- **Обработка границ**: Края изображения (1 пиксель по периметру) устанавливаются в 0, так как для них нельзя вычислить полный оператор Собеля
- **Нормализация**: Магнитуда градиента обрезается до 255 для корректного отображения
- **Производительность**: Использование GPU обеспечивает значительное ускорение по сравнению с CPU реализацией

## Возможные улучшения

- Поддержка форматов PNG и BMP (реализовано)
- Автоматическая конвертация RGB в grayscale (реализовано)
- Оптимизация с использованием shared memory
- Поддержка различных размеров масок (3x3, 5x5)
- Пороговая обработка для бинаризации границ
- Поддержка JPEG формата

## Замечания

- Для корректной работы требуется GPU с поддержкой CUDA
- Поддерживаются форматы: PGM (полностью), BMP (24-bit и 32-bit), PNG (требует stb_image)
- Максимальный размер изображения ограничен доступной памятью GPU
- Цветные изображения автоматически конвертируются в grayscale перед обработкой
- Для полной поддержки PNG см. файл `PNG_SUPPORT.md`

